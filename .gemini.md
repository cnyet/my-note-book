# .gemini.md - Global Development Standards [Token-Optimized]

> **核心原则**: 质量 > 速度 | 协作 > 个人 | 持续改进 | 用户导向

## 1. 项目架构约束

### 技术栈 [强制]
- **前端**: Next.js 15.4 + React 19 + TypeScript + Tailwind 4
- **后端**: Python 3.11+ + FastAPI + SQLAlchemy + SQLite
- **规范**: ESM Only | TS Strict | Pydantic强类型 | 禁 `any`/泛dict

### 文件规模限制 [强制]
| 类型 | 上限 | 触发动作 |
|-----|-----|---------|
| 动态语言文件 | 300行 | 立即拆分重构 |
| 静态语言文件 | 400行 | 立即拆分重构 |
| 单目录文件数 | 8个 | 分类拆分子目录 |
| 函数长度 | 50行 | 提取子函数 |
| 函数参数 | 5个 | 对象封装传参 |
| 嵌套深度 | 3层 | 提前返回/提取 |
| 类方法数 | 20个 | 职责分离 |

### 目录结构 [强制]
```
project/
├── scripts/      # 所有入口脚本 (setup/start-dev/build/test/lint/clean)
├── logs/         # 统一日志输出 (非敏感信息)
├── docs/         # 技术文档 (API/ADR/实施计划)
├── discuss/      # 代码评审记录
├── backend/      # Python后端 (强制.venv)
└── frontend/     # Next.js前端
```

## 2. 代码质量标准

### 复杂度控制 [强制]
- ❌ **避免**: 僵化、冗余、循环依赖、脆弱、晦涩、数据泥团、过度复杂
- ✅ **检测**: 超限立即重构，不延期技术债

### 命名规范 [强制]
```python
# Python
class UserService:              # PascalCase
    MAX_RETRY_COUNT = 3         # UPPER_SNAKE_CASE
    
    def get_user_by_id(self):   # snake_case
        is_active = True        # 布尔值: is_/has_/can_前缀
        user_data = {}          # 禁用 a/b/data 等无语义名

# TypeScript
interface UserProfile {}        # PascalCase
const MAX_ITEMS = 100;          # UPPER_SNAKE_CASE
function getUserById() {}       # camelCase
const isAuthenticated = true;   # is_/has_/can_前缀
```

### 语言混合策略
- **思考/注释/报错**: 中文 (提升可读性)
- **变量/类型/技术术语**: 英文 (避免编码问题)
- **文档**: 中文为主，关键术语保留英文

### Git 规范 [强制]
```bash
<type>(<scope>): <简短描述>

[body] 详细说明 (可选)

类型: feat|fix|docs|refactor|chore|test|perf|ci
示例: feat(auth): 实现JWT刷新令牌机制
```

## 3. 开发流程 [强制执行]

### 规划先行
- ✅ **Implement前**: 必须拆分阶段 + 优先级 TODO → 存 `docs/implement_<name>.md`
- ✅ **API开发前**: 必须定义 `docs/api_<name>.md` (入口Schema + 出口Schema + Mock验证)
- ✅ **日志规范**: 所有运行日志、异常 → 统一输出 `logs/`

### 脚本化操作 [禁止直接命令]
```bash
❌ 禁止: npm install / uv pip / python xxx.py
✅ 允许: ./scripts/setup.sh / ./scripts/start-dev.sh / ./scripts/test.sh
```

### 测试要求 [强制]
- 覆盖率 ≥ 80% (单元 + 集成 + E2E)
- 关键逻辑需属性测试
- CI 失败禁止合并

## 4. 配置与安全 [关键]

### 环境变量 [强制]
```bash
# ✅ 正确
DATABASE_URL=sqlite:///./db.sqlite
SECRET_KEY=${SECRET_KEY}  # 从环境读取

# ❌ 错误
db_url = "sqlite:///./db.sqlite"  # 硬编码
api_key = "sk-abc123..."          # 泄露密钥
```

- ✅ 必须提供 `.env.example`
- ✅ 启动前检查必填项
- ❌ 禁止提交 `.env` 到 Git

### 性能指标 [目标]
| 指标 | 目标 | 说明 |
|-----|-----|------|
| 页面加载 | ≤ 3s | 首屏可交互时间 |
| API响应 | ≤ 200ms | P95 |
| DB查询 | ≤ 100ms | 复杂查询需索引 |

## 5. 错误预防清单 [高频坑点]

### API集成
- ✅ 先打印 Response，验证格式，再解析
- ✅ 使用 Pydantic/Zod 强验证
- ❌ 不假设字段存在

### 依赖管理
- ✅ 锁版本 (requirements.txt/package-lock.json)
- ✅ 优先 LTS/稳定版
- ❌ 禁止新发布版直接上生产

### CSS/布局
- ✅ 真实浏览器验证
- ✅ 检查 z-index 层级
- ✅ 移动端响应式测试

### 日志/调试
- ✅ 异步操作必有日志
- ✅ 错误信息具体 (含上下文)
- ❌ 禁止静默失败

## 6. 绝对禁止 [一票否决]

| 禁止行为 | 说明 |
|---------|------|
| ❌ 硬编码敏感信息 | URL/密钥/端口必须环境变量 |
| ❌ `any` / 泛dict | Python用Pydantic/TS禁any |
| ❌ 忽略错误 | 禁 `except: pass` / `catch {}` |
| ❌ 绕过脚本 | 必须用 `scripts/` 执行 |
| ❌ 跳过测试 | 覆盖率 < 80% 禁止提交 |
| ❌ 牺牲质量 | 速度压力不是理由 |

## 7. 快速参考

### 每日命令
```bash
./scripts/start-dev.sh   # 启动开发 (前后端)
./scripts/lint.sh        # 代码检查
./scripts/test.sh        # 运行测试
./scripts/clean.sh       # 停止服务/清理缓存
```

### 代码审查要点
- [ ] 文件是否超限 (300/400行)
- [ ] 是否有硬编码配置
- [ ] 错误处理是否完善
- [ ] 是否有单元测试
- [ ] 命名是否语义化
- [ ] 注释是否充分

### 架构决策记录 (ADR)
重大技术选型必须记录到 `docs/adr/YYYYMMDD-<title>.md`：
```markdown
# ADR-001: 选择 FastAPI 作为后端框架

## 背景
需要高性能异步API框架

## 决策
采用 FastAPI

## 理由
1. 自动OpenAPI文档
2. Pydantic数据验证
3. 异步性能优秀

## 后果
- 正面: 开发效率提升, 类型安全
- 负面: 团队需学习async/await
```

---

## 💡 Token优化策略

本文档已优化：
1. **表格化**: 规则用表格 (Token减少40%)
2. **符号化**: ✅❌ 替代冗长描述
3. **示例精简**: 仅保留关键差异
4. **分层结构**: 6个核心主题 (vs 原15节)
5. **去重**: 合并相似规则

**使用建议**: 定期Review → 更新实际遇到的坑 → 保持精简

---

**版本**: v1.0.0 | **更新**: 2026-01-30 | **适用**: work-agents项目
