
# 通用开发约束和指导原则
> 适用于 Vibe Coding 的所有项目

## 🎯 核心理念

**四大价值观**：
1. **质量优先** - 质量比速度更重要，不为赶进度牺牲代码质量
2. **团队协作** - 团队协作比个人英雄主义更重要
3. **持续改进** - 技术在发展，我们也要持续学习和改进
4. **用户导向** - 代码是写给人看的，要考虑可读性和可维护性

---

## 📐 架构硬性指标

### 文件规模限制
- **动态语言**（Python、JavaScript、TypeScript）：每个文件 ≤ **300 行**
- **静态语言**（Java、Go、Rust）：每个文件 ≤ **400 行**
- **目录文件数**：每层文件夹 ≤ **8 个文件**，超过需规划子文件夹

### 函数复杂度限制
- 单个函数 ≤ 50 行
- 函数参数 ≤ 5 个
- 嵌套层级 ≤ 3 层
- 类方法数 ≤ 20 个

### 代码坏味道（必须避免）
1. **僵化** - 微小改动引发连锁修改
2. **冗余** - 相同逻辑在多处重复
3. **循环依赖** - 模块互相纠缠
4. **脆弱性** - 一处修改导致其他部分损坏
5. **晦涩性** - 代码意图不明
6. **数据泥团** - 多个数据项总是一起出现
7. **过度复杂** - 过度设计，系统臃肿

**🚨 重要**：识别代码坏味道时，立即询问是否需要优化并给出建议。

---

## 💬 沟通与文档

### 语言规范
- **中文**：思考、对话、业务注释、用户错误信息
- **英文**：变量命名、技术注释、系统日志

### 提交规范
```bash
<type>(<scope>): <description>

# 示例
feat(用户管理): 添加用户注册功能
fix(auth): resolve token refresh issue
docs(readme): 更新安装说明
```

### 文档组织
```
project/
├── docs/                 # 正式文档
│   ├── api/             # API 文档
│   ├── decisions/       # 架构决策记录 (ADR)
│   └── guides/          # 使用指南
├── discuss/             # 讨论和评审文档
└── README.md           # 项目概览
```

---

## 🚀 运行调试规范

### 脚本管理
- **统一入口**：所有操作使用 `scripts/` 目录下的 .sh 脚本
- **禁止直接命令**：不直接使用 npm、pnpm、uv、python 等命令
- **故障处理**：脚本失败时先修复脚本，然后继续使用

### 必需脚本
```bash
scripts/
├── setup.sh              # 项目初始化
├── start-dev.sh          # 启动开发环境
├── build.sh              # 构建项目
├── test.sh               # 运行测试
├── lint.sh               # 代码检查
└── clean.sh              # 清理构建文件
```

### 日志管理
- **统一输出**：所有日志输出到 `logs/` 目录
- **日志分级**：ERROR、WARN、INFO、DEBUG
- **敏感信息**：密码、API 密钥等绝不能出现在日志中

---

## 🐍 Python 规范

### 核心要求
- **虚拟环境**：永远使用 `.venv` 作为目录名
- **包管理器**：必须使用 `uv`，不使用 pip、poetry、conda
- **强类型**：数据结构全部定义成强类型，避免使用未定义的 dict
- **项目结构**：根目录保持简洁，main.py 内容简洁

### 类型安全示例
```python
# ✅ 正确：使用强类型
from pydantic import BaseModel
from typing import List, Optional

class User(BaseModel):
    id: str
    name: str
    email: Optional[str] = None

def get_users(limit: int = 10) -> List[User]:
    pass

# ❌ 错误：使用未定义的 dict
def get_users_bad(limit=10):
    return {"users": [...]}
```

---

## ⚛️ React/Next.js/TypeScript 规范

### 版本要求（严格执行）
- **Next.js**: v15.4
- **React**: v19
- **Tailwind CSS**: v4
- **模块系统**：严禁使用 CommonJS，必须使用 ES 模块

### 类型安全示例
```typescript
// ✅ 正确：使用强类型
interface User {
  id: string;
  name: string;
  email?: string;
}

interface UserListProps {
  users: User[];
  onUserSelect: (user: User) => void;
}

// ❌ 错误：使用 any
function UserListBad({ users }: { users: any[] }) {
  // 禁止
}
```

---

## 🧪 测试与质量

### 测试要求
- **覆盖率**：≥ 80%
- **测试分类**：单元测试、集成测试、端到端测试
- **属性测试**：关键业务逻辑必须编写属性测试
- **提交前检查**：必须运行完整测试套件

### 测试命名
```typescript
describe('UserService', () => {
  it('should create user with valid data', () => {
    // 测试实现
  });
});
```

---

## 🔒 安全规范

### 绝对禁止
- ❌ 硬编码密码、API 密钥、数据库连接字符串
- ❌ 忽略用户输入验证
- ❌ 在日志中输出敏感信息

### 必须执行
- ✅ 所有用户输入必须验证和清理
- ✅ 敏感数据必须加密存储
- ✅ 传输使用 HTTPS
- ✅ 定期检查和更新依赖包

---

## 📊 性能要求

### 性能预算
- 页面加载 ≤ 3 秒
- API 响应 ≤ 200ms (95%)
- 数据库查询 ≤ 100ms
- 并发支持 ≥ 100 用户

### 优化策略
- 合理使用索引，避免 N+1 查询
- 合理使用缓存，注意一致性
- 图片压缩、代码分割、懒加载
- 建立性能监控体系

---

## 🔄 版本控制

### 分支策略
- **main/master** - 生产环境
- **develop** - 开发环境
- **feature/** - 新功能开发
- **hotfix/** - 紧急修复

### 代码审查
- **必须审查**：所有代码必须经过 Code Review
- **响应时间**：24 小时内响应
- **小批量**：每次 PR 代码变更不宜过大

---

## 📦 依赖管理

### 核心原则
- **版本锁定**：使用 lock 文件锁定依赖版本
- **定期更新**：定期检查和更新依赖包
- **安全审计**：定期进行依赖安全审计
- **最小依赖**：只引入必要的依赖

### 新增依赖评估
- 必要性、维护状态、安全性、大小影响、替代方案

---

## 🌍 环境与配置

### 环境分离
- **开发环境** - 本地开发
- **测试环境** - 自动化测试
- **预生产环境** - 生产前验证
- **生产环境** - 正式服务

### 配置原则
- 所有配置外部化，不硬编码
- 使用环境变量管理敏感配置
- 提供合理的默认值
- 启动时验证必需配置

---

## ⚠️ 常见错误预防指南

### 基于项目实战的易错点总结

#### 1. API契约假设错误 (最高频)
**问题表现**：
- 前端显示"请求失败"但后端返回200 OK
- 数据解析错误，访问不存在的字段

**根本原因**：
- 前后端对响应格式理解不一致
- 缺乏明确的接口文档和数据格式约定

**预防措施**：
```typescript
// ❌ 错误：假设响应格式
const { access_token } = response.data;  // 假设有data包装

// ✅ 正确：验证响应格式
const response = await api.post('/auth/login', credentials);
console.log('API Response:', response); // 调试日志
const { access_token } = response;       // 根据实际格式访问
```

**强制要求**：
- 所有API调用必须先打印响应格式进行验证
- 前后端开发前必须确定接口契约
- 使用TypeScript接口定义API响应格式

#### 2. 依赖版本兼容性问题
**问题表现**：
- 新版本库在特定环境下报错
- 构建失败或运行时异常

**根本原因**：
- 使用过新或不稳定的版本
- 缺乏版本锁定和兼容性测试

**预防措施**：
```json
// ✅ 正确：使用稳定版本
{
  "next": "14.2.15",     // 稳定版本，不是最新的15.x
  "react": "18.3.1",     // 稳定版本，不是最新的19.x
  "bcrypt": "^5.1.0"     // 避免使用有兼容性问题的库
}
```

**强制要求**：
- 优先选择LTS或稳定版本
- 新项目避免使用刚发布的版本
- 升级前必须在测试环境验证兼容性
- 使用lock文件锁定依赖版本

#### 3. 环境配置管理混乱
**问题表现**：
- CORS错误，跨域请求被阻止
- 环境变量解析失败

**根本原因**：
- 开发/生产环境配置不一致
- 过度依赖环境变量导致配置复杂化

**预防措施**：
```python
# ❌ 错误：复杂的环境变量解析
allow_origins = settings.allowed_origins.split(",")

# ✅ 正确：简单明确的配置
allow_origins = [
    "http://localhost:3000", 
    "http://127.0.0.1:3000"
]
```

**强制要求**：
- 开发环境配置尽量简化，避免过度抽象
- 关键配置提供合理默认值
- 启动时验证必需配置是否存在

#### 4. CSS布局理解偏差
**问题表现**：
- 固定导航栏遮挡页面内容
- 响应式布局在不同屏幕尺寸下异常

**根本原因**：
- 对CSS定位、层级关系理解不准确
- 缺乏真实浏览器环境测试

**预防措施**：
```css
/* ❌ 错误：只调整内容区域 */
main { padding-top: 64px; }

/* ✅ 正确：调整容器级别 */
.main-container { padding-top: 64px; }
```

**强制要求**：
- 布局修改后必须在真实浏览器中测试
- 使用Chrome DevTools验证元素位置和层级
- 测试不同屏幕尺寸的响应式效果

#### 5. 错误处理和调试信息不足
**问题表现**：
- 问题难以定位，调试时间长
- 用户看到模糊的错误信息

**根本原因**：
- 缺少详细的日志和错误信息
- 错误处理不完善，静默失败

**预防措施**：
```typescript
// ❌ 错误：静默失败
try {
  await login(email, password);
} catch (error) {
  setError('登录失败');
}

// ✅ 正确：详细错误处理
try {
  console.log('🔐 开始登录:', { email });
  await login(email, password);
  console.log('✅ 登录成功');
} catch (error) {
  console.error('❌ 登录失败:', error);
  setError(error.message || '登录失败，请重试');
}
```

**强制要求**：
- 所有异步操作必须有详细的日志输出
- 错误信息要具体，帮助用户和开发者定位问题
- 关键流程添加调试日志，便于问题排查

### 错误预防检查清单

#### 开发前检查
- [ ] API接口格式已确认并文档化
- [ ] 依赖版本选择稳定版本
- [ ] 环境配置简化且有默认值
- [ ] 布局设计考虑了响应式需求

#### 开发中检查
- [ ] API调用添加了响应格式验证日志
- [ ] 错误处理完善，有详细错误信息
- [ ] CSS修改在浏览器中实际测试
- [ ] 关键流程添加了调试日志

#### 提交前检查
- [ ] 在不同浏览器和屏幕尺寸下测试
- [ ] 检查控制台是否有错误或警告
- [ ] 验证所有功能的错误处理路径
- [ ] 确认日志信息有助于问题定位

---

## 🧠 AI 协作与上下文优化

### 核心原则
- **效率优先** - 智能管理上下文提高响应速度
- **质量保证** - 压缩不影响代码生成质量
- **成本控制** - 合理使用 Token 预算
- **渐进式管理** - 按需加载，避免信息过载

### 上下文分层（四层优先级）

#### 🔴 关键层 - 始终保留
- 当前任务的具体要求
- 正在编辑的文件内容
- 类型定义和接口
- 错误信息和调试上下文

#### 🟡 重要层 - 可摘要压缩
- 项目架构概览
- API 接口定义
- 数据模型结构

#### 🟢 参考层 - 压缩为要点
- 代码规范和约束
- 最佳实践示例
- 配置文件模板

#### 🔵 归档层 - 高度压缩或引用
- 历史讨论记录
- 已完成的任务
- 详细的文档说明

### 上下文压缩技术

#### 代码摘要压缩
```typescript
// ❌ 完整代码 (高 Token 消耗)
export function UserService() {
  const [users, setUsers] = useState<User[]>([]);
  // ... 完整实现
}

// ✅ 压缩摘要 (低 Token 消耗)
/**
 * UserService Hook 摘要:
 * - 状态: users[], loading, error
 * - 方法: fetchUsers() - 异步获取用户列表
 * - 完整代码: hooks/useUserService.ts
 */
```

#### 文档结构化压缩
```markdown
## 用户管理模块 [COMPRESSED]
- **核心功能**: CRUD操作、认证、权限管理
- **API接口**: /api/users/* (详见 docs/api/users.md)
- **数据类型**: User, UserCreate, UserUpdate
- **完整文档**: docs/modules/user-management.md
```

### 渐进式上下文加载
```markdown
# 阶段1: 最小上下文 (任务启动)
- 任务目标、核心约束、当前文件

# 阶段2: 扩展上下文 (遇到问题)
- 相关接口、依赖模块、错误处理

# 阶段3: 完整上下文 (复杂问题)
- 详细文档、历史决策、完整代码
```

### Token 优化目标
- Token 节省 ≥ 30%
- 代码准确性 ≥ 95%
- 上下文相关性 ≥ 90%
- 响应时间提升 ≥ 40%

### 压缩检查清单

#### 必须保留
- ✅ 当前任务要求
- ✅ 正在编辑的代码
- ✅ 类型定义和接口
- ✅ 错误信息和堆栈

#### 可以压缩
- ⚠️ 项目架构文档
- ⚠️ API 接口规范
- ⚠️ 代码规范约束

#### 可以移除
- 🗑️ 历史讨论记录
- 🗑️ 过时的代码版本
- 🗑️ 重复的信息

---

## � 部署与理运维

### 部署策略
- **自动化部署** - 使用 CI/CD 流水线
- **环境一致性** - 各环境保持一致
- **回滚能力** - 快速回滚机制
- **健康检查** - 部署后健康检查

### 监控告警
- 应用性能监控
- 基础设施监控
- 业务指标监控
- 及时告警通知

---

## 👥 团队协作

### 协作原则
- **知识分享** - 定期技术分享
- **文档维护** - 及时更新文档
- **问题跟踪** - 使用 Issue 系统
- **决策记录** - 重要决策书面记录

### 上下文协作
- **模板标准化** - 统一的上下文模板
- **策略文档化** - 记录压缩策略
- **经验分享** - 分享优化经验
- **上下文交接** - 任务交接提供摘要

---

## 📈 持续改进

### 改进机制
- **定期回顾** - 代码质量和流程回顾
- **技术债务** - 识别和偿还技术债务
- **工具升级** - 及时升级开发工具
- **最佳实践** - 学习和应用最佳实践

---

## 🎯 质量检查清单

### 开发前
- [ ] 项目结构符合规范
- [ ] 依赖版本正确
- [ ] 脚本文件完整
- [ ] 环境配置正确

### 开发中
- [ ] 文件行数未超限
- [ ] 函数复杂度合理
- [ ] 无代码坏味道
- [ ] 错误处理完善
- [ ] 类型安全保证

### 提交前
- [ ] 所有测试通过
- [ ] 代码格式正确
- [ ] 类型检查通过
- [ ] 安全检查通过
- [ ] 性能符合要求

### 部署前
- [ ] 构建成功
- [ ] 集成测试通过
- [ ] 安全扫描通过
- [ ] 性能测试通过

---

## 🚨 绝对禁止

### 代码禁忌
- ❌ 硬编码敏感信息
- ❌ 使用 any 类型或未定义的 dict
- ❌ 忽略错误或静默失败
- ❌ 直接在主分支提交代码
- ❌ 跳过测试编写
- ❌ 提交未经测试的代码

### 流程禁忌
- ❌ 绕过代码审查流程
- ❌ 在生产环境直接修改代码
- ❌ 不记录重要技术决策
- ❌ 独自做重大技术决策
- ❌ 为赶进度牺牲代码质量

---

## 💡 最终提醒

**五大核心原则**：

1. **质量比速度更重要** - 不要为了赶进度而牺牲代码质量
2. **沟通比假设更重要** - 遇到不确定的技术决策时，要及时沟通讨论
3. **学习比固守更重要** - 持续学习和改进，技术在不断发展
4. **可读性比聪明更重要** - 代码是写给人看的，要考虑可读性和可维护性
5. **协作比个人更重要** - 团队协作比个人英雄主义更重要，要互相帮助，共同成长

**让我们一起用这些规范，打造高质量的软件产品！** 🚀