# 通用开发约束和指导原则
> 适用于 Vibe Coding 的所有项目

## 🎯 核心理念

**四大价值观**：质量优先、团队协作、持续改进、用户导向

---

## 📐 架构硬性指标

### 文件规模
- **动态语言**（Python/JS/TS）：≤ 300 行/文件
- **静态语言**（Java/Go/Rust）：≤ 400 行/文件
- **目录文件数**：≤ 8 个/层，超过需规划子文件夹

### 函数复杂度
- 函数 ≤ 50 行，参数 ≤ 5 个，嵌套 ≤ 3 层，类方法 ≤ 20 个

### 代码坏味道（必须避免）
僵化、冗余、循环依赖、脆弱性、晦涩性、数据泥团、过度复杂
**🚨 识别时立即询问是否需要优化**

---

## 💬 沟通与文档

- **语言**：中文（思考/对话/业务注释），英文（变量/技术注释/日志）
- **提交**：`<type>(<scope>): <description>` 示例：`feat(用户管理): 添加注册功能`
- **文档结构**：`docs/`(api/decisions/guides), `discuss/`, `README.md`

---

## 🚀 运行调试规范

- **脚本管理**：统一使用 `scripts/*.sh`，禁止直接使用 npm/pnpm/uv/python
- **必需脚本**：setup.sh, start-dev.sh, build.sh, test.sh, lint.sh, clean.sh
- **日志**：输出到 `logs/`，分级 ERROR/WARN/INFO/DEBUG，禁止输出敏感信息

---

## 🐍 Python 规范

- **虚拟环境**：`.venv` 目录名
- **包管理器**：必须使用 `uv`（不用 pip/poetry/conda）
- **强类型**：数据结构必须定义强类型，禁止未定义的 dict
- **类型示例**：
```python
# ✅ 正确
class User(BaseModel):
    id: str
    name: str
    email: Optional[str] = None
def get_users(limit: int = 10) -> List[User]: pass

# ❌ 错误：使用未定义的 dict
def get_users_bad(limit=10): return {"users": [...]}
```

---

## ⚛️ React/Next.js/TypeScript 规范

- **版本要求**：Next.js v15.4, React v19, Tailwind CSS v4
- **模块系统**：严禁 CommonJS，必须使用 ES 模块
- **类型安全**：禁止使用 `any`，必须定义接口类型

---

## 🧪 测试与质量

- **覆盖率**：≥ 80%
- **测试分类**：单元/集成/端到端测试
- **属性测试**：关键业务逻辑必须编写
- **提交前**：必须运行完整测试套件

---

## 🔒 安全规范

**禁止**：硬编码敏感信息、忽略输入验证、日志输出敏感信息
**必须**：输入验证清理、敏感数据加密、HTTPS传输、定期更新依赖

---

## 📊 性能要求

- 页面加载 ≤ 3s，API 响应 ≤ 200ms(95%)，数据库查询 ≤ 100ms，并发 ≥ 100 用户
- 优化：合理索引、避免 N+1、缓存一致性、图片压缩、代码分割、性能监控

---

## 🔄 版本控制

- **分支**：main(生产)、develop(开发)、feature/(功能)、hotfix/(修复)
- **审查**：必须 Code Review，24h 内响应，小批量 PR

---

## 📦 依赖管理

版本锁定(lock文件)、定期更新、安全审计、最小依赖。新增依赖评估：必要性/维护状态/安全性/大小/替代方案

---

## 🌍 环境与配置

- **环境分离**：开发/测试/预生产/生产
- **配置原则**：外部化、环境变量(敏感)、默认值、启动验证

---

## ⚠️ 常见错误预防（最高频5项）

### 1. API契约假设错误
**问题**：前端显示失败但后端200，数据解析错误
**预防**：API调用前打印响应格式验证，前后端确定接口契约，使用TS接口定义
```typescript
// ❌ 错误：假设响应格式
const { access_token } = response.data;
// ✅ 正确：验证响应格式
console.log('API Response:', response);
const { access_token } = response;
```

### 2. 依赖版本兼容性
**预防**：优先LTS/稳定版本，新项目避免刚发布版本，升级前测试环境验证，使用lock文件

### 3. 环境配置混乱
**预防**：开发环境简化配置，避免过度抽象，关键配置提供默认值，启动时验证必需配置

### 4. CSS布局偏差
**预防**：布局修改后真实浏览器测试，Chrome DevTools验证，测试不同屏幕尺寸

### 5. 错误处理不足
**预防**：异步操作详细日志，错误信息具体化，关键流程添加调试日志

**检查清单**：开发前(API格式确认/版本稳定/配置简化/响应式设计) → 开发中(响应验证/错误处理/CSS测试/调试日志) → 提交前(多浏览器测试/控制台检查/错误路径验证)

---

## 🧠 AI 协作与上下文优化

**核心原则**：效率优先、质量保证、成本控制、渐进式管理

**上下文分层**：
- 🔴 **关键层**：当前任务、编辑文件、类型定义、错误信息
- 🟡 **重要层**：项目架构、API定义、数据模型（可摘要压缩）
- 🟢 **参考层**：代码规范、最佳实践、配置模板（压缩为要点）
- 🔵 **归档层**：历史记录、已完成任务、详细文档（高度压缩）

**Token优化目标**：节省 ≥ 30%，准确性 ≥ 95%，相关性 ≥ 90%，响应时间提升 ≥ 40%

---

## 🚀 部署与运维

**部署**：自动化CI/CD、环境一致性、快速回滚、健康检查
**监控**：应用性能、基础设施、业务指标、及时告警

---

## 👥 团队协作

知识分享、文档维护、Issue跟踪、决策记录、上下文交接

---

## 📈 持续改进

定期回顾、技术债务识别偿还、工具升级、最佳实践学习

---

## 🎯 质量检查清单

**开发前**：项目结构、依赖版本、脚本文件、环境配置
**开发中**：文件行数、函数复杂度、代码坏味道、错误处理、类型安全
**提交前**：测试通过、代码格式、类型检查、安全检查、性能要求
**部署前**：构建成功、集成测试、安全扫描、性能测试

---

## 🚨 绝对禁止

**代码**：硬编码敏感信息、any/未定义dict、忽略错误、主分支直接提交、跳过测试
**流程**：绕过Code Review、生产环境直接修改、不记录决策、独自重大决策、牺牲质量

---

## 💡 五大核心原则

1. **质量比速度更重要**
2. **沟通比假设更重要**
3. **学习比固守更重要**
4. **可读性比聪明更重要**
5. **协作比个人更重要**
